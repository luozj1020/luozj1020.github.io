---
title: BUUCTF æ¯æ—¥æ‰“å¡ 2021-5-12
date: 2021-05-12
tags: Crypto
mathjax: true
---

# BUUCTF æ¯æ—¥æ‰“å¡ 2021-5-12

## å¼•è¨€

æ±‚ wp çš„æ—¶å€™ï¼Œå¤§ä½¬ä»¬å‘Šè¯‰æˆ‘ 2021 çº¢å¸½æ¯çš„ crypto éƒ½æ˜¯åŸé¢˜ã€‚ã€‚ã€‚
ä¸€å…±æœ‰ä¸‰ä»½ wp 
å…¶ä¸­ä¸¤ä»½çš„æ€è·¯æ˜¯ä¸€æ ·ï¼ˆä¹Ÿå°±æ˜¯åŸé¢˜çš„è§£ç­”ï¼‰ï¼Œå¦å¤–ä¸€ä»½æ˜¯å’Œæˆ‘åŒçº§çš„ Pheonix dl å½“æ—¶çš„è§£ç­”ï¼ˆæ„Ÿè°¢ Pheonix dlï¼ï¼‰èŠ±äº†ä¸€å°æ—¶è§£å‡ºæ¥çš„



## [2021 çº¢å¸½æ¯]primegame

[åŸé¢˜](https://www.secmem.org/blog/2020/09/20/poka-science-war-hacking/)åŠ å¯†ä»£ç å¦‚ä¸‹ï¼š
```python
#!/usr/bin/env python3

from decimal import *
import math
import random
import struct

from flag import flag

primes = [2]
for i in range(3, 100):
    f = True
    for j in primes:
        if i * i < j:
            break
        if i % j == 0:
            f = False
            break
    if f:
        primes.append(i)

# Random shuffle the primes
# Now you cannot know the order
seed = struct.unpack('<i', flag[5:9])[0]
random.seed(seed)
random.shuffle(primes)

# Use ln function
# Now you cannot know the key itself
getcontext().prec = 100
keys = []
for i in range(len(flag)):
    keys.append(Decimal(primes[i]).ln())

# Sum values
# Now you cannot know the flag
sum_ = Decimal(0.0)
for i, c in enumerate(flag):
    sum_ += c * Decimal(keys[i])

ct = math.floor(sum_ * 2 ** 256)
print(ct)
```
è¯¥ä»£ç çš„ç»“æ„å¦‚ä¸‹ï¼š
1ã€æŸ¥æ‰¾ä¸è¶…è¿‡100çš„ç´ æ•°ã€‚ï¼ˆå…±25ä¸ªï¼‰
2ã€é€šè¿‡ä½¿ç”¨ flag çš„ç¬¬6åˆ°ç¬¬9å­—èŠ‚ä½œä¸ºéšæœºç§å­ï¼Œå¯ä»¥å¯¹åè¿›åˆ¶ç´ æ•°æ•°ç»„è¿›è¡Œæ”¹ç»„ã€‚
3ã€æ¯ä¸ªæ”¹ç»„çš„ç´ æ•°éƒ½å–ä»¥ e ä¸ºåº•çš„å¯¹æ•°ï¼Œåè¿›åˆ¶ç²¾åº¦ä¸º100ã€‚
4ã€å°†ä¸Šä¸€æ­¥å¾—åˆ°çš„ ln å€¼ä¹˜ä»¥æ ‡è®°çš„æ¯ä¸ªå­—èŠ‚æ‰€è·å¾—çš„å€¼ç›¸åŠ ï¼Œä¹˜ä»¥ 2 ** 256 ç„¶åå››èˆäº”å…¥ã€‚

å¯¹æ¯”çº¢å¸½æ¯çš„åŠ å¯†ä»£ç ï¼š
```python
#!/usr/bin/env python3

from decimal import *
import math
import random
import struct
from flag import flag

assert (len(flag) == 48)
msg1 = flag[:24]
msg2 = flag[24:]
primes = [2]
# è·å– [2,90] çš„ç´ æ•°
for i in range(3, 90):
    f = True
    for j in primes:
        if i * i < j: # i^2 >= j
            break
        if i % j == 0:
            f = False
            break
    if f:
        primes.append(i)

getcontext().prec = 100 # ä¿ç•™ 100 ä½å°æ•°
keys = []
for i in range(len(msg1)): # len(primes) = 24
    keys.append(Decimal(primes[i]).ln())

sum_ = Decimal(0.0)
for i, c in enumerate(msg1):
    sum_ += c * Decimal(keys[i])

ct = math.floor(sum_ * 2 ** 256)
print(ct)
# 597952043660446249020184773232983974017780255881942379044454676980646417087515453
sum_ = Decimal(0.0)
for i, c in enumerate(msg2):
    sum_ += c * Decimal(keys[i])

ct = math.floor(sum_ * 2 ** 256)
print(ct)
# 425985475047781336789963300910446852783032712598571885345660550546372063410589918
```
å‘ç°åŸé¢˜ä»£ç ç»“æ„ä¸­çš„ç¬¬äºŒæ­¥ï¼ˆä¹Ÿå°±æ˜¯æ‰“ä¹±ç´ æ•°æ•°ç»„é¡ºåºï¼‰æ˜¯æ²¡æœ‰çš„ï¼ˆæˆ‘è¯´å“ªæ¥çš„ random å’Œ struct åº“ğŸ˜‚ï¼‰
è€Œä¸”å°† flag åˆ†æˆä¸¤æ®µåŠ å¯†ï¼Œå› æ­¤ç»™äº†ä¸¤ä¸ª ct

é¦–å…ˆï¼Œè¿™å¯ä»¥è½¬åŒ–æˆ[èƒŒåŒ…åŠ å¯†é—®é¢˜](https://blog.csdn.net/qq_33458986/article/details/104366177?utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~default-6.control&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~default-6.control)
èƒŒåŒ…åŠ å¯†æ˜¯å¯¹å¯†æ–‡çš„äºŒè¿›åˆ¶å­—ç¬¦ä¸²è¿›è¡ŒåŠ å¯†
è‡³äºä¸ºä»€ä¹ˆè¿™é“é¢˜æ˜¯èƒŒåŒ…åŠ å¯†ï¼Œå°±æˆ‘ä¸ªäººçš„ç†è§£çš„è¯ï¼Œå¤§å¤šæ•°åŠ å¯†é—®é¢˜éƒ½å¯ä»¥è½¬åŒ–æˆèƒŒåŒ…é—®é¢˜è§£å†³ï¼ˆä¾‹å¦‚ RSA ä¸­çš„ CopperSmith æ”»å‡»æ³•ï¼‰ï¼Œç»™æˆ‘çµæ„Ÿçš„æ˜¯ `2 ** 256` ä¹Ÿå°±æ˜¯ $2^{2^{8}}$ï¼Œè”æƒ³åˆ°å­—ç¬¦ 8 ä½äºŒè¿›åˆ¶ï¼ˆè™½ç„¶æ²¡ä»€ä¹ˆæ ¹æ®å°±æ˜¯äº†ï¼‰
æœ€åä¹Ÿæ²¡æœ‰æ€è·¯å°±æ˜¯äº†ã€‚ã€‚ã€‚

wp çš„è§£æ³•ä¹Ÿéƒ½æ˜¯è½¬åŒ–ä¸ºå¯¹ä¸¤æ®µåˆ†åˆ«è¿›è¡ŒèƒŒåŒ…é—®é¢˜æ±‚è§£



### Peonix dl è§£æ³•

dl çš„æ‰‹ç¨¿ï¼š
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20210511161219566.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MjQ0NjA5NQ==,size_16,color_FFFFFF,t_70)
é¦–å…ˆï¼Œå°† flag å‰24ä½è½¬åŒ–ä¸º 24\*8 ä½çš„äºŒè¿›åˆ¶
å› ä¸ºåŸæ¥çš„ keys æ˜¯ç›´æ¥å¯¹æ¯ä½ flag è¿›è¡Œæ“ä½œï¼Œè€Œç°åœ¨æ˜¯è¦å¯¹æ¯ä½äºŒè¿›åˆ¶è¿›è¡Œæ“ä½œï¼Œæ‰€ä»¥è¦é‡æ–°æ„é€  keys
ä»£ç å¦‚ä¸‹ï¼š

```python
from decimal import *
import math

flag = []
for i in range(48*8):
    flag.append(0)
assert (len(flag) == 48*8)
msg1 = flag[:24*8]
msg2 = flag[24*8:]
primes = [2]
for i in range(3, 90):
    f = True
    for j in primes:
        if i * i < j:
            break
        if i % j == 0:
            f = False
            break
    if f:
        primes.append(i)

getcontext().prec = 100
keys = []
for i in range(len(msg1)):
    keys.append(math.floor(2 ** 256 * (2 ** (i % 8)) * Decimal(primes[i//8]).ln()))
print(keys)
```
éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œçš„äºŒè¿›åˆ¶å­—ç¬¦ä¸²æ˜¯å€’åºçš„ï¼Œä¹‹åè§£å¯†éœ€è¦å€’å›æ¥
å¦‚æ‰‹ç¨¿ä¸­æ‰€å†™çš„ï¼Œç”±äºå¯¹ keys å‘ä¸‹å–æ•´äº†ï¼Œæ‰€ä»¥ç­”æ¡ˆä¼šåå°ï¼Œæ‰€ä»¥éœ€è¦è°ƒæ•´ cï¼ˆæ®è¯´è°ƒæ•´èŠ±äº†å¤§éƒ¨åˆ†æ—¶é—´ï¼Œè¿™ä¹Ÿæ˜¯è¿™ä¸ªæ–¹æ¡ˆçš„ä¸€ä¸ªç¼ºé™·ï¼‰
ç„¶åæ¥ä¸‹æ¥å°±æ˜¯æ„é€ çŸ©é˜µï¼Œç”¨ LLL ç®—æ³•è§£å‡ºæœ€çŸ­å‘é‡å¾—åˆ°ç»“æœäº†
è¿™é‡Œæ³¨æ„æœ€åç»“æœæ˜¯ä¸€ä¸ªæœ€åä¸€ä½æ˜¯ 0ï¼Œå…¶ä»–éƒ½æ˜¯ -1 æˆ– 1 çš„å‘é‡ï¼Œæœ‰æŠŠ -1 æ›¿æ¢æˆ 0 å’Œ 1 æ›¿æ¢æˆ 0 å¹¶ä¸” -1 æ›¿æ¢æˆ 1 ä¸¤ç§æƒ…å†µï¼Œéœ€è¦åˆ†åˆ«å°è¯•
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/2021051123223440.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl81MjQ0NjA5NQ==,size_16,color_FFFFFF,t_70)
æ€ä¹ˆæ„é€ çŸ©é˜µå‚ç…§[èƒŒåŒ…åŠ å¯†é—®é¢˜](https://blog.csdn.net/qq_33458986/article/details/104366177?utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~default-6.control&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~default-6.control)ï¼Œè‡³äº LLL ç®—æ³•ï¼Œæ›¾ç»åœ¨ç ”ç©¶ cryptohack çš„æ—¶å€™ dl å°è¯•å¤ç°è¿‡ï¼Œä½†æ˜¯éå¸¸æ…¢ï¼ˆå½“ç„¶æˆ‘ä¹Ÿè¯•è¿‡ï¼Œä½†æ˜¯å¤±è´¥äº†ï¼‰ï¼Œç”¨ sagemath å°è£…å¥½çš„é€Ÿåº¦ä¼šæ¯”è¾ƒå¿«
æœ€åæŠŠç»“æœå€’åºä¹‹å long_to_bytes å°±è¡Œäº†
ç»“æœä¸ºï¼š
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20210511232614320.png)
æˆ‘ä¸ªäººè®¤ä¸ºéš¾ç‚¹åœ¨äºæ„é€  keys ä»¥åŠæƒ³åˆ°å»æ„é€  keys ï¼Œè¿˜æœ‰å°±æ˜¯å­˜åœ¨éœ€è¦è°ƒæ•´ c è¿™ä¸ªç¼ºé™·
è‡³äºå…¶ä»–éƒ¨åˆ†ï¼Œæƒ³åˆ°èƒŒåŒ…é—®é¢˜å°±æ˜¯é¡ºç†æˆç« çš„äº†



### åŸé¢˜è§£æ³•

åœ¨[åŸé¢˜](https://www.secmem.org/blog/2020/09/20/poka-science-war-hacking/)ä¸­ï¼Œå°† flag ç›´æ¥ä½œä¸ºå­—ç¬¦ä¸²è€ƒè™‘ï¼Œè€Œä¸æ˜¯è½¬åŒ–ä¸ºäºŒè¿›åˆ¶å†æ±‚è§£
ä»£ç å¦‚ä¸‹ï¼š
```python
import math
from decimal import *
import random
import struct

getcontext().prec = int(100)

primes = [2]
for i in range(3, 100):
    f = True
    for j in primes:
        if i * i < j:
            break
        if i % j == 0:
            f = False
            break
    if f:
        primes.append(i)

keys = []
for i in range(len(primes)):
    keys.append(Decimal(int(primes[i])).ln())

arr = []
for v in keys:
    arr.append(int(v * int(16) ** int(64)))

ct = 737384863737803670841307970259513146291422299366557325168325233349136771464845311
#ct = 425985475047781336789963300910446852783032712598571885345660550546372063410589918

def encrypt(res):
    h = Decimal(int(0))
    for i in range(len(keys)):
        h += res[i] * keys[i]

    ct = int(h * int(16)**int(64))
    return ct

def f(N):
    ln = len(arr)
    A = Matrix(ZZ, ln + 1, ln + 1)
    for i in range(ln):
        A[i, i] = 1
        A[i, ln] = arr[i] // N
        A[ln, i] = 64

    A[ln, ln] = ct // N

    res = A.LLL()

    for i in range(ln + 1):
        flag = True
        for j in range(ln):
            if -64 <= res[i][j] < 64:
                continue
            flag = False
            break
        if flag:
            vec = [int(v + 64) for v in res[i][:-1]]
            ret = encrypt(vec)
            if ret == ct:
                print(N, bytes(vec))
            else:
                print("NO", ret, bytes(vec))

for i in range(2, 10000):
    print(i)
    f(i)
```
ç”±äº flag å®é™…ä¸Šæ˜¯å¯ä»¥è¾“å…¥çš„å€¼ï¼Œæ‰€ä»¥å°†è¿™ä¸ªé—®é¢˜è§†ä¸º0\~127èƒŒåŒ…è€Œä¸æ˜¯0/1èƒŒåŒ…ï¼Œå› æ­¤å®ƒä»¬ä¸èƒ½è¶…è¿‡128ï¼Œå› æ­¤æˆ‘ä»¬å°†è¾¹ç•Œè®¾ç½®ä¸º0\~127ã€‚
ç±»ä¼¼äºä¸Šæ–‡æ‰€è¿°çš„æ–¹æ³•æ„é€ çŸ©é˜µï¼Œå¯¹è§’çº¿ä½ç½®ç›¸åŒï¼Œè€Œå°†æœ€åä¸€è¡Œå‰é¢çš„æ•°æ›¿æ¢æˆ 64 (128/2)ï¼Œä¸åŒä¸Šæ–‡çš„ 1 (2/1)
è€Œåœ¨å¯»æ‰¾æœ€çŸ­å‘é‡çš„æ—¶å€™å°†èŒƒå›´é™åˆ¶åœ¨ [-64, 64] ï¼Œä¸åŒäºä¸Šæ–‡çš„ -1/1
è€Œè‡³äºæ•´é™¤ N çš„æ“ä½œï¼Œå¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ç§è¯¯å·®å¤„ç†çš„æ–¹å¼ï¼Œç”±äºåŠ å¯†æ—¶ä¹˜ $2^{256}$ é€ æˆäº†å¾ˆå¤§è¯¯å·®ï¼Œæ‰€ä»¥å°†å…¶æ”¾åœ¨ N ç¯ä¸Šè€Œä¸æ˜¯æ•´æ•°ç¯ä¸Šè®¨è®ºï¼ˆæˆ‘ä¹Ÿä¸æ‡‚è¿™æ˜¯ä»€ä¹ˆé“ç†ï¼Œä½†æ˜¯æ„Ÿè§‰å¾ˆæœ‰é“ç†ï¼‰
è€Œ keys å°±å’ŒåŸæ¥ä¸€æ ·ï¼Œåªæ˜¯æ¢äº†ä¸ªè¡¨ç¤º



## ç»“è¯­

äº‹å®ä¸Šï¼Œç±»ä¼¼çš„é—®é¢˜ä¹Ÿå¯ä»¥ç”¨ç±»ä¼¼çš„æ–¹æ³•è§£ï¼Œå¦‚åŸé¢˜ wp ä¸­æåˆ°çš„ cryptohack ä¸­çš„ä¸€é¢˜
å¤ªæ™šäº†æ˜å¤©å†è¯´
åˆ†æ wp ç©¶ç«Ÿèƒ½å­¦åˆ°ä»€ä¹ˆå‘¢ï¼Ÿåªèƒ½è¯´é•¿ç‚¹è§è¯†å§ï¼Œæˆ‘è§çš„è¿˜æ˜¯å¤ªå°‘äº†
å¤ªå¼±å°äº†ï¼Œå› ä¸º æˆ‘ä»¬æ²¡æœ‰åŠ›é‡~
å¸Œæœ›ç»§ç»­åšæŒ